# Semantic Layer Definition: Payments Table
# Defines the payments data model with dimensions and measures

model:
  name: payments
  description: "Payment transactions including amounts, dates, and payment methods"
  table: payments
  schema: public
  

fields:
  - name: payment_id
    type: serial4
    description: Unique identifier for the payment.
    role: entity

  - name: subscription_id
    type: int4
    description: Foreign key linking to the subscriptions table.
    role: relationship
    related_table: subscriptions
    related_field: subscription_id

  - name: payment_date
    type: timestamp
    description: Date when the payment was made.
    role: dimension

  - name: amount_usd
    type: numeric(10, 2)
    description: The payment amount in USD.
    role: measure

  - name: method
    type: varchar(255
    description: The payment method used (e.g., card, paypal).
    role: entity

relationships:
 - subscriptions.subscription_id -> payments.subscription_id

measures:
  - name: total_revenue_usd
    formula: SUM(total_amount)
    description: Total revenue generated from all payments.

  - name: payment_count
    formula: count(*)
    description: Volume of Successful payments for subscriptions

  - name: avg_payment_amount
    formula: AVG(amount_avg)
    description: Average value of a payment

  - name: daily_revenue_usd
    formula:   
  	     DATE(payment_date) AS payment_day,
  	     SUM(amount_usd) AS daily_revenue_usd
    description: Daily revenue received per specific date

golden_queries:
  - name: Total Revenue By Date
    description: Total revenue obtained over a period of time between two dates.	
    sql: 
SELECT 
    SUM(amount_usd) AS total_revenue_usd
FROM payments
WHERE payment_date >= '2025-01-01 00:00:00.000'
  AND payment_date <  '2025-06-30 00:00:00.000';

  - name: Subscription Lifetime Revenue Top 10
    description: The amount revenue of the Top 10 paying subsciptions.
    sql: 
SELECT 
    subscription_id,
    SUM(amount_usd) AS lifetime_revenue_usd
FROM payments
GROUP BY subscription_id
ORDER BY lifetime_revenue_usd DESC
LIMIT 10;

  - name: Revenue by Method
    description: The amount of revenue by payment method.
    sql: 
SELECT 
    method,
    SUM(amount_usd) AS revenue_usd,
    COUNT(*) AS payment_count,
    ROUND(
        100.0 * SUM(amount_usd) / SUM(SUM(amount_usd)) OVER (),
        2
    ) AS revenue_pct
FROM payments
WHERE payment_date >= '2025-01-01 00:00:00.000'
  AND payment_date <  '2025-06-30 00:00:00.000'
GROUP BY method
ORDER BY revenue_usd DESC;

  - name: Rolling 7-day revenue
    description: Revenue total over a rolling 7-day period of time.
    sql: 

WITH daily AS (
    SELECT 
        DATE(payment_date) AS day,
        SUM(amount_usd) AS revenue_usd
    FROM payments
    WHERE payment_date >= '2025-01-01 00:00:00.000'
      AND payment_date <  '2025-06-30 00:00:00.000'
    GROUP BY DATE(payment_date)
)
SELECT 
    day,
    revenue_usd,
    SUM(revenue_usd) OVER (
        ORDER BY day
        ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
    ) AS revenue_usd_7d
FROM daily
ORDER BY day;