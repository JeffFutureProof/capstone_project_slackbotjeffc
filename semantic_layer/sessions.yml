# Semantic Layer Definition: Sessions Table
# Defines the sessions data model with dimensions and measures

model:
  name: sessions
  description: "User session data including activity types, duration, and engagement metrics"
  table: sessions
  schema: public
  

fields:
  - name: session_id
    type: serial4
    description: Unique identifier for the session.
    role: x

  - name: user_id
    type: serial4
    description: Unique identifier for the user.
    role: relationship

  - name: session_date
    type: timestamp
    description: Date and time when the session occurred.
    role: dimension

  - name: duration_minutes
    type: int4
    description: Duration of the session in minutes.
    role: dimension

  - name: activity_type
    type: varchar(255)
    description: The main activity performed during the session (e.g., browse, listen, read).
    role: dimension

relationships:
  - users.user_id -> sessions.user_id

measures:
  - name: session_count
    formula: count(*)
    description: quantity of total sessions

  - name: avg_session_minutes 
    formula: AVG(duration_minutes)
    description: average duration of sessions in minutes

  - name: sessions_per_user
    formula: COUNT(*) / COUNT (DISTINCT user_id)
    description: Count the quantity of sessions per user.

  - name: sessions_by_activity_type
    formula: activity_type, COUNT(*) AS session_count
    description: Quantity of sessions by activity type (browse, listen, 	read, 

  - name: minutes_per_user
    formula: SUM(duration_minutes) / COUNT(DISTINCT user_id)
    description:  How many total minutes per user and what is the average duration of a user session?

golden_queries:
  - name: Sessions KPI data over time	
    description: Core KPI snapshot of sessions over designated time.
    sql: 
SELECT
    COUNT(*) AS session_count,
    COUNT(DISTINCT user_id) AS distinct_users,
    ROUND(AVG(duration_minutes), 2) AS avg_session_minutes,
    percentile_cont(0.5) WITHIN GROUP (ORDER BY duration_minutes) AS median_session_minutes,
    SUM(duration_minutes) AS total_minutes
FROM sessions
WHERE session_date::date = '2025-09-01';

  - name: sessions_by_activity_type
    description: Sessions by activity type, total duration and average session duration by type
    sql: 
SELECT 
    activity_type,
    COUNT(*) AS session_count,
    SUM(duration_minutes) AS total_minutes,
    ROUND(AVG(duration_minutes), 2) AS avg_session_minutes
FROM sessions
GROUP BY activity_type
ORDER BY total_minutes DESC;

  - name: Activity mix (sessions & minutes)
    description: Activity types broken down by sessions and durations
    sql: 
SELECT
  activity_type,
  COUNT(*) AS sessions,
  ROUND(100.0 * COUNT(*) / SUM(COUNT(*)) OVER (), 2) AS sessions_pct,
  SUM(duration_minutes) AS minutes,
  ROUND(100.0 * SUM(duration_minutes) / SUM(SUM(duration_minutes)) OVER (), 2) AS minutes_pct
FROM sessions
GROUP BY activity_type
ORDER BY minutes DESC;