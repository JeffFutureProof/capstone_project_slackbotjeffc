# Semantic Layer Definition: Users Table
# Defines the users data model with dimensions and measures

model:
  name: users
  description: "User accounts and their attributes including geography and device information"
  table: users
  schema: public
  

fields:
  - name: user_id
    type: serial4
    description: Unique identifier for the user.
    role: relationship

  - name: signup_date
    type: timestamp
    description: Date and time when the user signed up.
    role: dimension

  - name: country
    type: varchar(255)
    description: User country, based on Ip geolocation during signup
    role: geo

  - name: device_type
    type: varchar(255)
    description: The type of device used for signing up (e.g., iOS, Android, Web).
    role: entity

relationships:
  - users.user_id -> sessions.user_id
  - users.user_id -> subscriptions.user_id

measures:
  - name: total_users
    formula: count(*)
    description: total number of registered users.

  - name: active_users_in_period
    formula: COUNT(DISTINCT user_id) joined to sessions within period
    description: Measures engagement; often DAU/WAU/MAU.

  - name: new_users_in_period
    formula: COUNT(*) WHERE signup_date BETWEEN start_date AND end_date
    description: Track user acquisition volume over time.

  - name: retained_users
    formula: Retained Users=COUNT(DISTINCT user_id) where user_id∈
(Active Users in Previous Period∩ Active Users in Current Period)
    description: Users who were active in prior period and current period

  - name: churned_users
    formula: Churned Users = Active Users in Previous Period − Retained Users
    description: Users who were active last period but not current period

golden_queries:
  - name: daily_new_users
    description: Daily new users (with 7-day rolling average)
    sql:     description: Daily new users (with 7-day rolling average)
    sql: 
WITH daily AS (
  SELECT DATE(signup_date) AS day, COUNT(*) AS new_users
  FROM users
  GROUP BY 1
)
SELECT
  day,
  new_users,
  ROUND(
    AVG(new_users) OVER (ORDER BY day ROWS BETWEEN 6 PRECEDING AND CURRENT ROW),
    2
  ) AS new_users_7d_avg
FROM daily
ORDER BY day;

  - name: new_user_country
    description: Top countries by new users (last 30 days)
    sql: 
SELECT
  country,
  COUNT(*) AS new_users_30d,
  ROUND(100.0 * COUNT(*) / SUM(COUNT(*)) OVER (), 2) AS pct_of_total
FROM users
WHERE signup_date >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY country
ORDER BY new_users_30d DESC
LIMIT 10;

  - name: conversion_by_device
    description: Signup → Active-subscriber conversion by device (point-in-time: today)
    sql: 
WITH active_subs AS (
  SELECT DISTINCT user_id
  FROM subscriptions
  WHERE start_date <= CURRENT_DATE
    AND (end_date IS NULL OR end_date > CURRENT_DATE)
)
SELECT
  u.device_type,
  COUNT(*) AS users,
  COUNT(a.user_id) AS subscribed_users,
  ROUND(100.0 * COUNT(a.user_id) / NULLIF(COUNT(*), 0), 2) AS conversion_pct
FROM users u
LEFT JOIN active_subs a USING (user_id)
GROUP BY u.device_type
ORDER BY conversion_pct DESC, users DESC;